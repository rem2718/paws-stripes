<script>
    const status = (response) => {
        if (response.status >= 200 && response.status < 300) {
            return Promise.resolve(response)
        } else {
            return Promise.reject(new Error(response.statusText))
        }
    };

    const json = (response) => {
        return response.json()
    }

    const arrPrint = (arr) => {
        let output = ""; arr.forEach((element) => {
            output += `${element}, `;
        });
        return output.slice(0, -2);
    };

    const deletePet = (petID) => {
        console.log(petID);
        fetch(`/api/pets/${petID}`, {
            method: 'delete',
            credentials: 'include',
            headers: {
                "Content-type": "application/json"
            },
        })
            .then(status)
            .then(json)
            .then((response) => {
                console.log(response);
                const card = document.getElementById(`card-${response.id}`);
                card.remove();

            })
            .catch((error) => {
                console.log(error.message);
                window.location.href = `/err-response/${error.message}`;
            });
    }

    const editPet = (petID) => {
        fetch(`/api/pets/${petID}`, {
            method: 'PUT',
            credentials: 'include',
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify({
                name: document.getElementById(`name-${petID}`).value,
                type: document.getElementById(`type-${petID}`).value,
                breed: document.getElementById(`breed-${petID}`).value,
                age: document.getElementById(`age-${petID}`).value,
                personality: document.getElementById(`personality-${petID}`).value,
            })
        })
            .then(status)
            .then(json)
            .then((response) => {
                console.log(response);
            })
            .catch((error) => {
                console.log(error);
                window.location.href = `/err-response/${error.message}`;
            });
    }

    const displayPets = (pets) => {
        const container = document.getElementById("cards-container");
        container.innerHTML = '';
        pets.forEach(pet => {
            const card = document.createElement("div");
            card.className = "card";
            card.id = `card-${pet.petID}`;
            card.innerHTML = `
                <img src="${pet.image}" alt="Card 1" />
                <div class="card-text">
                    <ul>
                        <li>Pet ID: ${pet.petID}
                        </li>
                        <li>Name: ${pet.name}
                        </li>
                        <li>Type: ${pet.type}
                        </li>
                        <li>Breed: ${pet.breed}
                        </li>
                        <li>Age: ${pet.age}
                        </li>
                        <li>Personality: ${arrPrint(pet.personality)}
                        </li>
                    </ul>
                </div>
                <% if (cookies.userType !="admin" ) { %>
                    <a href="/api/adopt/${pet.petID}"><button class="btn btn-primary">Adopt</button></a>
                <% } else { %>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-${pet.petID}">edit</button>
                    <button onclick="deletePet('${pet.petID}')" class="btn btn-primary">Delete</button>
                    <div class="modal" id="modal-${pet.petID}">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title">Edit Pet</h4>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form>
                                        <label for="name"><b>pet name:</b></label><br>
                                        <input type="text" name="name" id="name-${pet.petID}" value="${pet.name}" required /><br>
                                        <label for="type"><b>pet type:</b></label><br>
                                        <input type="text" name="type" id="type-${pet.petID}" value="${pet.type}" required /><br>
                                        <label for="breed"><b>pet breed:</b></label><br>
                                        <input type="text" name="breed" id="breed-${pet.petID}" value="${pet.breed}"  required /><br>
                                        <label for="age"><b>pet age:</b></label><br>
                                        <input type="text" name="age" id="age-${pet.petID}" value="${pet.age}"  required /><br>
                                        <label for="personality"><b>pet personality:</b></label><br>
                                        <input type="text" name="personality" id="personality-${pet.petID}" value="${arrPrint(pet.personality)}" required /><br>                    
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button onclick="editPet('${pet.petID}')" class="btn btn-info">send</button>
                                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                <% } %>
            `;
            container.appendChild(card);
        });
    }

    const getPets = () => {
        fetch(`/api/pets`, {
            method: 'GET',
            headers: {
                "Content-type": "application/json"
            }
        })
            .then(status)
            .then(json)
            .then((response) => {
                console.log('Request succeeded with JSON response', response);
                displayPets(response);
            })
            .catch((error) => {
                console.log(error.message);
                window.location.href = `/err-response/${error.message}`;
            });
    }
    getPets();
</script>